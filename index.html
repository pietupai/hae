<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request to Vercel API</title>
</head>
<body>
    <h1>Request to Vercel API</h1>
    <select id="urlSelect">
        <option value="www.iki.fi">www.iki.fi</option>
        <option value="www.google.com">www.google.com</option>
        <option value="www.example.com">www.example.com</option>
    </select>
    <button id="sendRequestButton">Send Request</button>
    <pre id="responseContent"></pre>

    <script>
        async function fetchFile(url) {
            try {
                const response = await fetch(`https://proxyserver2-sandy.vercel.app/api/fetch-proxy?url=${url}`);
                const responseData = await response.text();

                if (responseData.trim().startsWith("<!doctype html>") || responseData.trim().startsWith("<HTML>") || responseData.trim().startsWith("<HEAD>")) {
                    console.log(`HTML response for ${url}:`, responseData);
                    return responseData;
                } else {
                    try {
                        const data = JSON.parse(responseData);
                        const decodedContent = atob(data.content.replace(/\n/g, ''));
                        console.log(`JSON response for ${url}:`, decodedContent);
                        return decodedContent;
                    } catch (error) {
                        console.error(`Error parsing JSON for ${url}:`, error);
                        return responseData;
                    }
                }
            } catch (error) {
                console.error(`Error fetching URL ${url}:`, error);
                throw error;
            }
        }

        async function fetchInitialFiles() {
            const requestUrl = 'https://api.github.com/repos/pietupai/hae/contents/request.txt?timestamp=' + new Date().getTime();
            const responseUrl = 'https://api.github.com/repos/pietupai/hae/contents/response.txt?timestamp=' + new Date().getTime();

            const initialRequestText = await fetchFile(requestUrl);
            await new Promise(resolve => setTimeout(resolve, 500));
            const initialResponseText = await fetchFile(responseUrl);

            return { initialRequestText, initialResponseText };
        }

        async function pollResponse(responseUrl, responseContent, initialResponseText, maxPollCount, pollDelay) {
            let pollCount = 0;
            console.log('Starting polling...');
            await new Promise(resolve => setTimeout(resolve, pollDelay)); // Initial delay before polling

            const poll = async () => {
                try {
                    pollCount++;
                    console.log(`Poll count: ${pollCount}`);
                    const currentResponseText = await fetchFile(responseUrl);
                    console.log(`Polling response (${pollCount}):`, currentResponseText);
                    if (currentResponseText && currentResponseText !== initialResponseText) {
                        responseContent.textContent = currentResponseText;
                        return;
                    }
                    if (pollCount >= maxPollCount) {
                        responseContent.textContent = 'Polling stopped after maximum attempts. Please try again.';
                        return;
                    }
                    setTimeout(poll, pollDelay);
                    pollDelay *= 2; // Exponential backoff
                } catch (error) {
                    console.error(`Error fetching response for ${responseUrl}:`, error);
                    responseContent.textContent = `Error fetching response: ${error.message}`;
                }
            };
            poll();
        }

        window.onload = async function () {
            const responseContent = document.getElementById('responseContent');
            try {
                const { initialRequestText, initialResponseText } = await fetchInitialFiles();
                responseContent.textContent = initialResponseText;
            } catch (error) {
                console.error('Error in window.onload function:', error);
                responseContent.textContent = `Error in window.onload: ${error.message}`;
            }
        };

        document.getElementById('sendRequestButton').onclick = async function () {
            const urlSelect = document.getElementById('urlSelect').value;
            const responseContent = document.getElementById('responseContent');
            responseContent.textContent = 'Sending request...';

            if (!urlSelect) {
                responseContent.textContent = 'Please select a URL';
                return;
            }

            const requestUrl = 'https://api.github.com/repos/pietupai/hae/contents/request.txt?timestamp=' + new Date().getTime();
            const responseUrl = 'https://api.github.com/repos/pietupai/hae/contents/response.txt?timestamp=' + new Date().getTime();

            try {
                console.log('Fetching initial files before sending request...');
                const { initialRequestText, initialResponseText } = await fetchInitialFiles();
                console.log('Initial files fetched:', { initialRequestText, initialResponseText });

                console.log('Fetching current request and response files...');
                const currentRequestText = await fetchFile(requestUrl);
                await new Promise(resolve => setTimeout(resolve, 500));
                const currentResponseText = await fetchFile(responseUrl);
                console.log('Current files fetched:', { currentRequestText, currentResponseText });

                if (currentRequestText !== responseContent.textContent) {
                    console.log('Triggering workflow...');
                    const response = await fetch('https://proxyserver2-sandy.vercel.app/api/trigger-workflow', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain'
                        },
                        body: JSON.stringify({ url: urlSelect })
                    });
                    console.log('Workflow response:', response);

                    if (response.ok) {
                        responseContent.textContent = 'Request sent successfully! Waiting for the response...';
                        pollResponse(responseUrl, responseContent, responseContent.textContent, 20, 5000);
                    } else {
                        const errorText = await response.text();
                        console.error('Workflow error:', errorText);
                        responseContent.textContent = `Error: ${errorText}`;
                    }
                } else {
                    responseContent.textContent = currentResponseText;
                }
            } catch (error) {
                console.error('Request failed:', error);
                responseContent.textContent = `Request failed: ${error.message}`;
            }
        };
    </script>
</body>
</html>
